<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>منشئ السيرة الذاتية</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&family=Noto+Sans+Arabic:wght@300;400;500;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>منشئ السيرة الذاتية</h1>
      <p>أنشئ سيرتك الذاتية وترتيب الأقسام بالسحب والإفلات</p>
    </header>

    <div class="main-layout">
      <div class="form-column">

    <!-- Basic info -->
    <section class="form-section" id="personal-info">
      <h2>المعلومات الشخصية</h2>
      <button type="button" class="secondary" style="margin-bottom: 1rem;" onclick="loadExampleCV()">تحميل سيرة مثال</button>
      <div class="grid">
        <label>الاسم الكامل<input name="name" required></label>
        <label>البريد الإلكتروني<input name="email" type="email" required></label>
        <label>الجوال<input name="phone"></label>
        <label>لينكدإن<input name="linkedin" placeholder="https://linkedin.com/in/yourname"></label>
        <label>جيت هب<input name="github" placeholder="https://github.com/yourname"></label>
        <label>الموقع<input name="website" placeholder="https://yourwebsite.com"></label>
      </div>
    </section>

    <!-- Summary Section -->
    <section class="form-section" id="summary">
      <div class="section-header">
        <input type="text" class="section-title-input" value="Summary" data-section="summary" onchange="updateSectionName('summary', this.value)">
        <button type="button" class="remove-section-btn" onclick="removeSection('summary')">إزالة القسم</button>
      </div>
      <div class="section-content">
        <label>الملخص المهني<textarea name="summary" rows="3" placeholder="نظرة عامة مختصرة عن خلفيتك المهنية والإنجازات الرئيسية..."></textarea></label>
      </div>
    </section>

    <!-- Custom Headers -->
    <section class="form-section">
      <h2>روابط إضافية</h2>
      <div id="custom-headers"></div>
      <button class="secondary" type="button" onclick="addCustomHeader()">+ إضافة رابط</button>
    </section>

    <!-- Experience (dynamic list) -->
    <section class="form-section">
      <div class="section-header">
        <input type="text" class="section-title-input" value="Experience" data-section="experience" onchange="updateSectionName('experience', this.value)">
        <button type="button" class="remove-section-btn" onclick="removeSection('experience')">إزالة القسم</button>
      </div>
      <div id="experience" class="section-content">
        <p class="empty-state help-text">لا توجد عناصر بعد.</p>
      </div>
      <button class="secondary" type="button" onclick="addExperience()">+ إضافة خبرة</button>
    </section>

    <!-- Education -->
    <section class="form-section">
      <div class="section-header">
        <input type="text" class="section-title-input" value="Education" data-section="education" onchange="updateSectionName('education', this.value)">
        <button type="button" class="remove-section-btn" onclick="removeSection('education')">إزالة القسم</button>
      </div>
      <div id="education" class="section-content">
        <p class="empty-state help-text">لا توجد عناصر بعد.</p>
      </div>
      <button class="secondary" type="button" onclick="addEducation()">+ إضافة تعليم</button>
    </section>

    <!-- Research Experience -->
    <section class="form-section" id="section-researchexperience">
      <div class="section-header">
        <input type="text" class="section-title-input" value="Research Experience" data-section="researchexperience" onchange="updateSectionName('researchexperience', this.value)">
        <button type="button" class="remove-section-btn" onclick="removeSection('researchexperience')">إزالة القسم</button>
      </div>
      <div id="researchexperience" class="section-content">
        <p class="empty-state help-text">لا توجد عناصر بعد.</p>
      </div>
      <button class="secondary" type="button" onclick="addResearchExperience()">+ إضافة خبرة بحثية</button>
    </section>

    <!-- Industry Experience -->
    <section class="form-section" id="section-industryexperience">
      <div class="section-header">
        <input type="text" class="section-title-input" value="Industry Experience" data-section="industryexperience" onchange="updateSectionName('industryexperience', this.value)">
        <button type="button" class="remove-section-btn" onclick="removeSection('industryexperience')">إزالة القسم</button>
      </div>
      <div id="industryexperience" class="section-content">
        <p class="empty-state help-text">لا توجد عناصر بعد.</p>
      </div>
      <button class="secondary" type="button" onclick="addIndustryExperience()">+ إضافة خبرة عملية</button>
    </section>

    <!-- Projects -->
    <section class="form-section">
      <div class="section-header">
        <input type="text" class="section-title-input" value="Projects" data-section="projects" onchange="updateSectionName('projects', this.value)">
        <button type="button" class="remove-section-btn" onclick="removeSection('projects')">إزالة القسم</button>
      </div>
      <div id="projects" class="section-content">
        <p class="empty-state help-text">لا توجد عناصر بعد.</p>
      </div>
      <button class="secondary" type="button" onclick="addProject()">+ إضافة مشروع</button>
    </section>

    <!-- Publications (Optional) -->
    <section class="form-section">
      <div class="section-header">
        <input type="text" class="section-title-input" value="Publications" data-section="publications" onchange="updateSectionName('publications', this.value)">
        <button type="button" class="remove-section-btn" onclick="removeSection('publications')">إزالة القسم</button>
      </div>
      <div id="publications" class="section-content">
        <p class="empty-state help-text">لا توجد عناصر بعد.</p>
      </div>
      <button class="secondary" type="button" onclick="addPublication()">+ إضافة منشور</button>
    </section>

    <!-- Skills -->
    <section class="form-section">
      <div class="section-header">
        <input type="text" class="section-title-input" value="Skills" data-section="skills" onchange="updateSectionName('skills', this.value)">
        <button type="button" class="remove-section-btn" onclick="removeSection('skills')">إزالة القسم</button>
      </div>
      <div id="skills" class="section-content">
        <div class="row">
          <input placeholder="الفئة (مثال: لغات البرمجة)" class="skill-cat">
          <input placeholder="المهارات (مفصولة بفواصل)" class="skill-items">
        </div>
      </div>
      <button class="secondary" type="button" onclick="addSkillRow()">+ إضافة فئة مهارات</button>
    </section>

    <!-- Certifications -->
    <section class="form-section">
      <div class="section-header">
        <input type="text" class="section-title-input" value="Certifications" data-section="certifications" onchange="updateSectionName('certifications', this.value)">
        <button type="button" class="remove-section-btn" onclick="removeSection('certifications')">إزالة القسم</button>
      </div>
      <div id="certifications" class="section-content">
        <p class="empty-state help-text">لا توجد عناصر بعد.</p>
      </div>
      <button class="secondary" type="button" onclick="addCertification()">+ إضافة شهادة</button>
    </section>

    <!-- Honors & Awards -->
    <section class="form-section" id="section-honorsawards">
      <div class="section-header">
        <input type="text" class="section-title-input" value="Honors & Awards" data-section="honorsawards" onchange="updateSectionName('honorsawards', this.value)">
        <button type="button" class="remove-section-btn" onclick="removeSection('honorsawards')">إزالة القسم</button>
      </div>
      <div id="honorsawards" class="section-content">
        <p class="empty-state help-text">لا توجد عناصر بعد.</p>
      </div>
      <button class="secondary" type="button" onclick="addHonorsAwards()">+ إضافة جائزة أو تقدير</button>
    </section>

    <!-- Volunteering -->
    <section class="form-section" id="section-volunteering">
      <div class="section-header">
        <input type="text" class="section-title-input" value="Volunteering" data-section="volunteering" onchange="updateSectionName('volunteering', this.value)">
        <button type="button" class="remove-section-btn" onclick="removeSection('volunteering')">إزالة القسم</button>
      </div>
      <div id="volunteering" class="section-content">
        <p class="empty-state help-text">لا توجد عناصر بعد.</p>
      </div>
      <button class="secondary" type="button" onclick="addVolunteering()">+ إضافة عمل تطوعي</button>
    </section>

    <!-- Custom sections -->
    <section class="form-section">
      <h2>أقسام مخصصة</h2>
      <div id="custom-sections"></div>
      <button class="secondary" type="button" onclick="addCustomSection()">+ إضافة قسم مخصص</button>
    </section>

    <!-- Drag & drop ordering -->
    <section class="form-section">
      <h2>ترتيب الأقسام</h2>
      <p class="help-text">اسحب القطع لإعادة ترتيب الأقسام في سيرتك الذاتية.</p>
      <ul id="order" class="order">
        <!-- Sections will be populated dynamically -->
      </ul>
    </section>

    <div class="generate-section">
      <button id="submit" class="primary">تحميل السيرة (PDF)</button>
      <p class="help-text" style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">محتوى السيرة يجب أن يكون بالإنجليزية لإنشاء PDF.</p>
      <p id="success-msg" class="success-msg hidden" aria-live="polite">السيرة جاهزة — بدأ التحميل.</p>
      <div id="loading" class="loading hidden">
        <div class="spinner"></div>
        <span>جارٍ إنشاء سيرتك الذاتية...</span>
      </div>
    </div>
      </div>

      <div class="preview-column" dir="ltr">
        <div class="preview-header">
          <h2>معاينة السيرة</h2>
          <span class="preview-status" id="preview-status"></span>
        </div>
        <div id="cv-preview" class="cv-preview">
          <div class="preview-placeholder">
            <p>املأ النموذج لرؤية معاينة سيرتك الذاتية هنا</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ----- Helper functions for adding form sections -----
    function addExperience() {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="card-header">
          <h4>الخبرة العملية</h4>
          <button type="button" class="remove-btn" onclick="this.parentElement.parentElement.remove(); updatePreview(); updateSectionOrderList();">×</button>
        </div>
        <div class="grid">
          <input placeholder="المسمى الوظيفي" oninput="updatePreview()">
          <input placeholder="الشركة" oninput="updatePreview()">
          <input placeholder="الموقع" oninput="updatePreview()">
          <input placeholder="التواريخ (مثال: يناير 2023 - الحاضر)" oninput="updatePreview()">
        </div>
        <textarea placeholder="الإنجازات والمسؤوليات الرئيسية (سطر واحد لكل نقطة)" oninput="updatePreview()"></textarea>
      `;
      document.getElementById('experience').appendChild(el);
      updatePreview();
      updateSectionOrderList();
    }

    function addEducation() {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="card-header">
          <h4>التعليم</h4>
          <button type="button" class="remove-btn" onclick="this.parentElement.parentElement.remove(); updatePreview(); updateSectionOrderList();">×</button>
        </div>
        <div class="grid">
          <input placeholder="الجامعة/المؤسسة" oninput="updatePreview()">
          <input placeholder="الموقع" oninput="updatePreview()">
          <input placeholder="الدرجة والتخصص" oninput="updatePreview()">
          <input placeholder="تاريخ التخرج" oninput="updatePreview()">
        </div>
      `;
      document.getElementById('education').appendChild(el);
      updatePreview();
      updateSectionOrderList();
    }

    function addProject() {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="card-header">
          <h4>المشروع</h4>
          <button type="button" class="remove-btn" onclick="this.parentElement.parentElement.remove(); updatePreview(); updateSectionOrderList();">×</button>
        </div>
        <div class="grid">
          <input placeholder="اسم المشروع" oninput="updatePreview()">
          <input placeholder="التواريخ" oninput="updatePreview()">
          <input placeholder="التقنيات المستخدمة" oninput="updatePreview()">
          <input placeholder="رابط المشروع (اختياري)" class="project-link" oninput="updatePreview()">
        </div>
        <textarea placeholder="وصف المشروع والميزات الرئيسية (سطر واحد لكل نقطة)" oninput="updatePreview()"></textarea>
      `;
      document.getElementById('projects').appendChild(el);
      updatePreview();
      updateSectionOrderList();
    }

    function addPublication() {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="card-header">
          <h4>المنشور</h4>
          <button type="button" class="remove-btn" onclick="this.parentElement.parentElement.remove(); updatePreview(); updateSectionOrderList();">×</button>
        </div>
        <div class="grid">
          <input placeholder="عنوان المنشور" oninput="updatePreview()">
          <input placeholder="تاريخ النشر" oninput="updatePreview()">
          <input placeholder="الناشر/المجلة" oninput="updatePreview()">
          <input placeholder="الرابط (اختياري)" class="publication-link" oninput="updatePreview()">
        </div>
        <textarea placeholder="تفاصيل إضافية (سطر واحد لكل نقطة)" oninput="updatePreview()"></textarea>
      `;
      document.getElementById('publications').appendChild(el);
      updatePreview();
      updateSectionOrderList();
    }

    function addSkillRow() {
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `
        <input placeholder="الفئة" class="skill-cat" oninput="updatePreview()">
        <input placeholder="المهارات (مفصولة بفواصل)" class="skill-items" oninput="updatePreview()">
        <button type="button" class="remove-btn" onclick="this.parentElement.remove(); updatePreview();">×</button>
      `;
      document.getElementById('skills').appendChild(row);
      updatePreview();
      updateSectionOrderList();
    }

    function addCertification() {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="card-header">
          <h4>الشهادة</h4>
          <button type="button" class="remove-btn" onclick="this.parentElement.parentElement.remove(); updatePreview(); updateSectionOrderList();">×</button>
        </div>
        <div class="grid">
          <input placeholder="اسم الشهادة" oninput="updatePreview()">
          <input placeholder="تاريخ الإصدار" oninput="updatePreview()">
          <input placeholder="الجهة المصدرة" oninput="updatePreview()">
        </div>
      `;
      document.getElementById('certifications').appendChild(el);
      updatePreview();
      updateSectionOrderList();
    }

    function addResearchExperience() {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="card-header">
          <h4>الخبرة البحثية</h4>
          <button type="button" class="remove-btn" onclick="this.parentElement.parentElement.remove(); updatePreview(); updateSectionOrderList();">×</button>
        </div>
        <div class="grid">
          <input placeholder="الدور/المسمى" oninput="updatePreview()">
          <input placeholder="المنظمة" oninput="updatePreview()">
          <input placeholder="الموقع" oninput="updatePreview()">
          <input placeholder="التواريخ (مثال: يناير 2025 - الحاضر)" oninput="updatePreview()">
        </div>
        <textarea placeholder="النقاط الرئيسية (سطر واحد لكل نقطة)" oninput="updatePreview()"></textarea>
      `;
      document.getElementById('researchexperience').appendChild(el);
      updatePreview();
      updateSectionOrderList();
    }

    function addIndustryExperience() {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="card-header">
          <h4>الخبرة العملية</h4>
          <button type="button" class="remove-btn" onclick="this.parentElement.parentElement.remove(); updatePreview(); updateSectionOrderList();">×</button>
        </div>
        <div class="grid">
          <input placeholder="المسمى الوظيفي" oninput="updatePreview()">
          <input placeholder="الشركة" oninput="updatePreview()">
          <input placeholder="الموقع" oninput="updatePreview()">
          <input placeholder="التواريخ (مثال: يناير 2025 - الحاضر)" oninput="updatePreview()">
        </div>
        <textarea placeholder="الإنجازات الرئيسية (سطر واحد لكل نقطة)" oninput="updatePreview()"></textarea>
      `;
      document.getElementById('industryexperience').appendChild(el);
      updatePreview();
      updateSectionOrderList();
    }

    function addHonorsAwards() {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="card-header">
          <h4>الجائزة/التقدير</h4>
          <button type="button" class="remove-btn" onclick="this.parentElement.parentElement.remove(); updatePreview(); updateSectionOrderList();">×</button>
        </div>
        <div class="grid">
          <input placeholder="اسم الجائزة" oninput="updatePreview()">
          <input placeholder="المنظمة" oninput="updatePreview()">
          <input placeholder="الموقع" oninput="updatePreview()">
          <input placeholder="التاريخ" oninput="updatePreview()">
        </div>
        <textarea placeholder="التفاصيل (سطر واحد لكل نقطة)" oninput="updatePreview()"></textarea>
      `;
      document.getElementById('honorsawards').appendChild(el);
      updatePreview();
      updateSectionOrderList();
    }

    function addVolunteering() {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="card-header">
          <h4>العمل التطوعي</h4>
          <button type="button" class="remove-btn" onclick="this.parentElement.parentElement.remove(); updatePreview(); updateSectionOrderList();">×</button>
        </div>
        <div class="grid">
          <input placeholder="الدور" oninput="updatePreview()">
          <input placeholder="المنظمة" oninput="updatePreview()">
          <input placeholder="الموقع" oninput="updatePreview()">
          <input placeholder="التواريخ" oninput="updatePreview()">
        </div>
        <textarea placeholder="النقاط الرئيسية (سطر واحد لكل نقطة)" oninput="updatePreview()"></textarea>
      `;
      document.getElementById('volunteering').appendChild(el);
      updatePreview();
      updateSectionOrderList();
    }

    async function loadExampleCV() {
      try {
        const response = await fetch('/api/example-cv');

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(`فشل تحميل سيرة المثال: ${response.status} ${errorData.error || response.statusText}`);
        }
        
        const data = await response.json();
        populateFormFromData(data);
      } catch (error) {
        console.error('خطأ في تحميل سيرة المثال:', error);
        alert(`فشل تحميل سيرة المثال: ${error.message}\n\nتحقق من وحدة تحكم المتصفح للتفاصيل.`);
      }
    }

    function populateFormFromData(data) {
      // Clear all existing form data first
      document.querySelector('[name="name"]').value = '';
      document.querySelector('[name="email"]').value = '';
      document.querySelector('[name="phone"]').value = '';
      document.querySelector('[name="linkedin"]').value = '';
      document.querySelector('[name="github"]').value = '';
      document.querySelector('[name="website"]').value = '';
      document.querySelector('[name="summary"]').value = data.summary || '';
      
      // Clear all sections
      document.getElementById('education').innerHTML = '<p class="empty-state help-text">لا توجد عناصر بعد.</p>';
      document.getElementById('researchexperience').innerHTML = '<p class="empty-state help-text">لا توجد عناصر بعد.</p>';
      document.getElementById('industryexperience').innerHTML = '<p class="empty-state help-text">لا توجد عناصر بعد.</p>';
      document.getElementById('projects').innerHTML = '<p class="empty-state help-text">لا توجد عناصر بعد.</p>';
      document.getElementById('publications').innerHTML = '<p class="empty-state help-text">لا توجد عناصر بعد.</p>';
      document.getElementById('skills').innerHTML = '<div class="row"><input placeholder="الفئة (مثال: لغات البرمجة)" class="skill-cat"><input placeholder="المهارات (مفصولة بفواصل)" class="skill-items"></div>';
      document.getElementById('certifications').innerHTML = '<p class="empty-state help-text">لا توجد عناصر بعد.</p>';
      document.getElementById('honorsawards').innerHTML = '<p class="empty-state help-text">لا توجد عناصر بعد.</p>';
      document.getElementById('volunteering').innerHTML = '<p class="empty-state help-text">لا توجد عناصر بعد.</p>';
      document.getElementById('custom-headers').innerHTML = '';
      
      // Fill personal info
      document.querySelector('[name="name"]').value = data.name || '';
      document.querySelector('[name="email"]').value = data.email || '';
      document.querySelector('[name="phone"]').value = data.phone || '';
      document.querySelector('[name="linkedin"]').value = data.linkedin || '';
      document.querySelector('[name="github"]').value = data.github || '';
      document.querySelector('[name="website"]').value = data.website || '';
      
      // Add custom headers
      if (data.custom_headers && data.custom_headers.length > 0) {
        data.custom_headers.forEach(header => {
          addCustomHeader();
          const headerCards = document.querySelectorAll('#custom-headers .card');
          const lastCard = headerCards[headerCards.length - 1];
          if (lastCard) {
            const inputs = lastCard.querySelectorAll('input');
            if (inputs.length >= 2) {
              inputs[0].value = header.label || '';
              inputs[1].value = header.value || '';
            }
          }
        });
      }
      
      // Education
      if (data.education && data.education.length > 0) {
        data.education.forEach(edu => {
          addEducation();
          const cards = document.querySelectorAll('#education .card');
          const card = cards[cards.length - 1];
          if (card) {
            const [university, location, degree, date] = card.querySelectorAll('input');
            university.value = edu.university || '';
            location.value = edu.location || '';
            degree.value = edu.degree || '';
            date.value = edu.date || '';
          }
        });
      }
      
      // Research Experience
      if (data.researchexperience && data.researchexperience.length > 0) {
        data.researchexperience.forEach(exp => {
          addResearchExperience();
          const cards = document.querySelectorAll('#researchexperience .card');
          const card = cards[cards.length - 1];
          if (card) {
            const [title, company, location, dates] = card.querySelectorAll('input');
            const ta = card.querySelector('textarea');
            title.value = exp.title || '';
            company.value = exp.company || '';
            location.value = exp.location || '';
            dates.value = exp.dates || '';
            if (ta && exp.bullets && exp.bullets.length > 0) {
              ta.value = exp.bullets.join('\n');
            }
          }
        });
      }
      
      // Industry Experience
      if (data.industryexperience && data.industryexperience.length > 0) {
        data.industryexperience.forEach(exp => {
          addIndustryExperience();
          const cards = document.querySelectorAll('#industryexperience .card');
          const card = cards[cards.length - 1];
          if (card) {
            const [title, company, location, dates] = card.querySelectorAll('input');
            const ta = card.querySelector('textarea');
            title.value = exp.title || '';
            company.value = exp.company || '';
            location.value = exp.location || '';
            dates.value = exp.dates || '';
            if (ta && exp.bullets && exp.bullets.length > 0) {
              ta.value = exp.bullets.join('\n');
            }
          }
        });
      }
      
      // Publications
      if (data.publications && data.publications.length > 0) {
        data.publications.forEach(pub => {
          addPublication();
          const cards = document.querySelectorAll('#publications .card');
          const card = cards[cards.length - 1];
          if (card) {
            const [title, date, publisher, link] = card.querySelectorAll('input');
            const ta = card.querySelector('textarea');
            title.value = pub.title || '';
            date.value = pub.date || '';
            publisher.value = pub.publisher || '';
            if (link) link.value = pub.link || '';
            if (ta && pub.bullets && pub.bullets.length > 0) {
              ta.value = pub.bullets.join('\n');
            }
          }
        });
      }
      
      // Projects
      if (data.projects && data.projects.length > 0) {
        data.projects.forEach(proj => {
          addProject();
          const cards = document.querySelectorAll('#projects .card');
          const card = cards[cards.length - 1];
          if (card) {
            const inputs = card.querySelectorAll('input');
            const [name, dates, description, link] = inputs;
            const ta = card.querySelector('textarea');
            if (name) name.value = proj.name || '';
            if (dates) dates.value = proj.dates || '';
            if (description) description.value = proj.description || '';
            if (link) link.value = proj.link || '';
            if (ta && proj.bullets && proj.bullets.length > 0) {
              ta.value = proj.bullets.join('\n');
            }
          }
        });
      }
      
      // Skills
      if (data.skills && typeof data.skills === 'object') {
        const skillContainer = document.getElementById('skills');
        skillContainer.innerHTML = '';
        Object.entries(data.skills).forEach(([category, items]) => {
          addSkillRow();
          const rows = document.querySelectorAll('#skills .row');
          const row = rows[rows.length - 1];
          if (row) {
            row.querySelector('.skill-cat').value = category || '';
            row.querySelector('.skill-items').value = Array.isArray(items) ? items.join(', ') : items;
          }
        });
      }
      
      // Honors & Awards
      if (data.honorsawards && data.honorsawards.length > 0) {
        data.honorsawards.forEach(honor => {
          addHonorsAwards();
          const cards = document.querySelectorAll('#honorsawards .card');
          const card = cards[cards.length - 1];
          if (card) {
            const [title, company, location, dates] = card.querySelectorAll('input');
            const ta = card.querySelector('textarea');
            title.value = honor.title || '';
            company.value = honor.company || '';
            location.value = honor.location || '';
            dates.value = honor.dates || '';
            if (ta && honor.bullets && honor.bullets.length > 0) {
              ta.value = honor.bullets.join('\n');
            }
          }
        });
      }
      
      // Volunteering
      if (data.volunteering && data.volunteering.length > 0) {
        data.volunteering.forEach(vol => {
          addVolunteering();
          const cards = document.querySelectorAll('#volunteering .card');
          const card = cards[cards.length - 1];
          if (card) {
            const [title, company, location, dates] = card.querySelectorAll('input');
            const ta = card.querySelector('textarea');
            title.value = vol.title || '';
            company.value = vol.company || '';
            location.value = vol.location || '';
            dates.value = vol.dates || '';
            if (ta && vol.bullets && vol.bullets.length > 0) {
              ta.value = vol.bullets.join('\n');
            }
          }
        });
      }
      
      // Certifications
      if (data.certifications && data.certifications.length > 0) {
        data.certifications.forEach(cert => {
          addCertification();
          const cards = document.querySelectorAll('#certifications .card');
          const card = cards[cards.length - 1];
          if (card) {
            const [name, date, provider] = card.querySelectorAll('input');
            name.value = cert.name || '';
            date.value = cert.date || '';
            provider.value = cert.provider || '';
          }
        });
      }
      // Set section order from JSON - need to call updateSectionOrderList first to populate the list
      updateSectionOrderList();
      
      if (data.order && Array.isArray(data.order)) {
        const orderList = document.getElementById('order');
        if (!orderList) {
          return;
        }
        
        const orderMap = {};
        Array.from(orderList.children).forEach(li => {
          const sectionId = li.getAttribute('data-section-id');
          if (sectionId) {
            orderMap[sectionId] = li;
          }
        });
        
        // Clear the list
        orderList.innerHTML = '';
        
        // Add items in the order specified by JSON
        data.order.forEach(sectionName => {
          // Find the section ID for this canonical name
          const sectionId = Object.keys(SECTION_ID_TO_CANONICAL).find(
            id => SECTION_ID_TO_CANONICAL[id] === sectionName
          );
          if (sectionId && orderMap[sectionId]) {
            orderList.appendChild(orderMap[sectionId]);
            delete orderMap[sectionId];
          }
        });
        
        // Add any remaining sections that weren't in the order
        Object.values(orderMap).forEach(li => {
          orderList.appendChild(li);
        });
      }
      
      // Update preview
      updatePreview();
    }

    function addCustomHeader() {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="card-header">
          <h4>رابط مخصص</h4>
          <button type="button" class="remove-btn" onclick="this.parentElement.parentElement.remove()">×</button>
        </div>
        <div class="grid">
          <input placeholder="التسمية (مثال: معرض الأعمال)">
          <input placeholder="الرابط (مثال: https://myportfolio.com)">
        </div>
      `;
      document.getElementById('custom-headers').appendChild(el);
    }

    function addCustomSection() {
      const wrap = document.createElement('div');
      wrap.className = 'card';
      wrap.innerHTML = `
        <div class="card-header">
          <input placeholder="عنوان القسم المخصص (مثال: العمل التطوعي، الجوائز)" class="section-title" onchange="updateCustomSectionOrder()">
          <button type="button" class="remove-btn" onclick="removeCustomSection(this)">×</button>
        </div>
        <div class="blocks"></div>
        <button type="button" class="secondary small" onclick="addCustomBlock(this)">+ إضافة عنصر</button>
      `;
      document.getElementById('custom-sections').appendChild(wrap);
      updateCustomSectionOrder();
    }

    function removeCustomSection(btn) {
      btn.parentElement.parentElement.remove();
      updateCustomSectionOrder();
    }

    function updateCustomSectionOrder() {
      const orderList = document.getElementById('order');
      const customSections = document.querySelectorAll('#custom-sections .card .section-title');
      
      // Remove existing custom section items from order list
      const existingCustomItems = orderList.querySelectorAll('li[data-custom="true"]');
      existingCustomItems.forEach(item => item.remove());
      
      // Add current custom sections to order list
      customSections.forEach(input => {
        const title = input.value.trim();
        if (title) {
          const li = document.createElement('li');
          li.textContent = title;
          li.draggable = true;
          li.setAttribute('data-custom', 'true');
          orderList.appendChild(li);
        }
      });
    }

    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      const sectionContent = section.querySelector('.section-content');
      const addButton = section.querySelector('.secondary');
      const removeBtn = section.querySelector('.remove-section-btn');
      
      if (!sectionContent || !addButton || !removeBtn) {
        console.error('Could not find required elements for section:', sectionId);
        return;
      }
      
      if (sectionContent.style.display === 'none') {
        // Show section
        sectionContent.style.display = 'block';
        addButton.style.display = 'block';
        removeBtn.textContent = 'Remove Section';
        removeBtn.classList.remove('restore-btn');
        removeBtn.classList.add('remove-section-btn');
      } else {
        // Hide section
        sectionContent.style.display = 'none';
        addButton.style.display = 'none';
        removeBtn.textContent = 'Restore Section';
        removeBtn.classList.remove('remove-section-btn');
        removeBtn.classList.add('restore-btn');
      }
      
      // Update section order list
      updateSectionOrderList();
    }

    function removeSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.display = 'none';
        updateSectionOrderList();
        updatePreview();
      }
    }

    function restoreSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.display = 'block';
        updateSectionOrderList();
        updatePreview();
      }
    }

    function updateSectionName(sectionId, newName) {
      // Update the section order list
      updateSectionOrderList();
    }

    // Map section IDs (DOM) to canonical names sent to backend (SECTION_BUILDERS keys)
    const SECTION_ID_TO_CANONICAL = {
      summary: 'Summary',
      education: 'Education',
      researchexperience: 'Research Experience',
      industryexperience: 'Industry Experience',
      experience: 'Experience',
      projects: 'Projects',
      publications: 'Publications',
      skills: 'Skills',
      honorsawards: 'Honors & Awards',
      volunteering: 'Volunteering',
      certifications: 'Certifications'
    };

    function hasNonLatin(s) {
      if (!s || typeof s !== 'string') return false;
      for (let i = 0; i < s.length; i++) {
        const code = s.charCodeAt(i);
        if ((code >= 0x0600 && code <= 0x06FF) || (code >= 0x0750 && code <= 0x077F) || (code >= 0x08A0 && code <= 0x08FF))
          return true;
      }
      return false;
    }
    function payloadHasNonLatin(obj) {
      if (typeof obj === 'string') return hasNonLatin(obj);
      if (Array.isArray(obj)) return obj.some(payloadHasNonLatin);
      if (obj && typeof obj === 'object') return Object.values(obj).some(payloadHasNonLatin);
      return false;
    }

    function getOrderFromList() {
      return Array.from(document.querySelectorAll('#order li')).map(li => {
        const sectionId = li.getAttribute('data-section-id');
        if (sectionId && SECTION_ID_TO_CANONICAL[sectionId])
          return SECTION_ID_TO_CANONICAL[sectionId];
        if (li.getAttribute('data-custom') === 'true')
          return 'Custom:' + li.textContent.trim();
        return null;
      }).filter(Boolean);
    }

    function updateSectionOrderList() {
      const orderList = document.getElementById('order');
      if (!orderList) return;
      
      const sectionMappings = {
        'Summary': 'summary',
        'Education': 'education',
        'Research Experience': 'researchexperience',
        'Industry Experience': 'industryexperience',
        'Experience': 'experience',
        'Publications': 'publications',
        'Projects': 'projects',
        'Skills': 'skills',
        'Honors & Awards': 'honorsawards',
        'Volunteering': 'volunteering',
        'Certifications': 'certifications'
      };

      // Preserve current order before rebuilding
      const currentOrder = getOrderFromList();
      const currentOrderMap = new Map();
      Array.from(orderList.children).forEach(li => {
        const sectionId = li.getAttribute('data-section-id');
        if (sectionId) {
          currentOrderMap.set(sectionId, {
            text: li.textContent,
            element: li
          });
        }
      });

      // Helper function to resolve section element correctly
      function resolveSectionElement(sectionId) {
        // Try direct ID first
        let element = document.getElementById(sectionId);
        if (!element) {
          // Try section- prefix
          element = document.getElementById('section-' + sectionId);
        }
        
        if (!element) return null;
        
        // If it's a section-content div, get its parent form-section
        if (element.classList.contains('section-content')) {
          return element.closest('.form-section') || element;
        }
        
        // If it's already a form-section, use it
        if (element.classList.contains('form-section')) {
          return element;
        }
        
        // Otherwise try to find parent form-section
        return element.closest('.form-section') || element;
      }

      // Build map of available sections
      const availableSections = new Map();
      Object.entries(sectionMappings).forEach(([sectionName, sectionId]) => {
        const sectionEl = resolveSectionElement(sectionId);
        if (!sectionEl) return;
        
        const sectionContent = sectionEl.querySelector('.section-content');
        const titleInput = sectionEl.querySelector('.section-title-input');
        
        // Check visibility
        const isVisible = sectionEl.style.display !== 'none' && 
                         sectionContent && 
                         sectionContent.style.display !== 'none';
        
        if (isVisible) {
          const displayTitle = titleInput ? titleInput.value : sectionName;
          availableSections.set(sectionId, {
            title: displayTitle,
            canonicalName: sectionName
          });
        }
      });

      // Clear the list
      orderList.innerHTML = '';

      // Rebuild list preserving current order
      // First, add sections in current order (if they still exist)
      currentOrder.forEach(canonicalName => {
        // Reverse lookup: canonicalName -> sectionId
        const foundEntry = Object.entries(sectionMappings).find(
          ([name, id]) => name === canonicalName
        );
        
        if (foundEntry) {
          const [, sectionId] = foundEntry;
          if (availableSections.has(sectionId)) {
            const sectionInfo = availableSections.get(sectionId);
            const li = document.createElement('li');
            li.textContent = sectionInfo.title;
            li.setAttribute('data-section-id', sectionId);
            li.draggable = true;
            orderList.appendChild(li);
            availableSections.delete(sectionId); // Remove from available
          }
        }
      });

      // Add any remaining sections that weren't in current order
      availableSections.forEach((sectionInfo, sectionId) => {
        const li = document.createElement('li');
        li.textContent = sectionInfo.title;
        li.setAttribute('data-section-id', sectionId);
        li.draggable = true;
        orderList.appendChild(li);
      });

      // Add custom sections
      updateCustomSectionOrder();
    }

    function addCustomBlock(btn) {
      const blocks = btn.parentElement.querySelector('.blocks');
      const el = document.createElement('div');
      el.className = 'card sub';
      el.innerHTML = `
        <div class="card-header">
          <h5>العنصر</h5>
          <button type="button" class="remove-btn" onclick="this.parentElement.parentElement.remove()">×</button>
        </div>
        <div class="grid">
          <input placeholder="العنوان">
          <input placeholder="التواريخ">
          <input placeholder="المنظمة">
          <input placeholder="الموقع">
        </div>
        <textarea placeholder="التفاصيل (سطر واحد لكل نقطة)"></textarea>
      `;
      blocks.appendChild(el);
    }

    // Drag & drop ordering
    (function() {
      const list = document.getElementById('order');
      let dragEl = null;
      
      list.addEventListener('dragstart', e => { 
        dragEl = e.target; 
        e.dataTransfer.effectAllowed = 'move';
        e.target.classList.add('dragging');
      });
      
      list.addEventListener('dragend', e => {
        e.target.classList.remove('dragging');
        dragEl = null;
        // Update preview when drag ends
        updatePreview();
      });
      
      list.addEventListener('dragover', e => { 
        e.preventDefault(); 
        const li = e.target.closest('li'); 
        if (li && li !== dragEl) { 
          const rect = li.getBoundingClientRect();
          const midY = rect.top + rect.height / 2;
          if (e.clientY < midY) {
            list.insertBefore(dragEl, li);
          } else {
            list.insertBefore(dragEl, li.nextSibling);
          }
        } 
      });
      
      list.addEventListener('drop', e => { 
        e.preventDefault(); 
      });
    })();

    // Form submission and PDF generation
    document.getElementById('submit').addEventListener('click', async () => {
      const submitBtn = document.getElementById('submit');
      const loading = document.getElementById('loading');
      
      // Show loading state
      submitBtn.style.display = 'none';
      loading.classList.remove('hidden');

      const payload = {
        name: document.querySelector('[name="name"]').value,
        email: document.querySelector('[name="email"]').value,
        phone: document.querySelector('[name="phone"]').value,
        linkedin: document.querySelector('[name="linkedin"]').value,
        github: document.querySelector('[name="github"]').value,
        website: document.querySelector('[name="website"]').value,
        summary: document.querySelector('[name="summary"]').value,
        education: [],
        experience: [],
        researchexperience: [],
        industryexperience: [],
        projects: [],
        publications: [],
        skills: {},
        certifications: [],
        honorsawards: [],
        volunteering: [],
        custom_sections: [],
        custom_headers: [],
        section_names: {},
        order: getOrderFromList()
      };

      // Education
      document.querySelectorAll('#education .card').forEach(card => {
        const [university, location, degree, date] = card.querySelectorAll('input');
        payload.education.push({ 
          university: university.value, 
          location: location.value, 
          degree: degree.value, 
          date: date.value 
        });
      });

      // Experience
      document.querySelectorAll('#experience .card').forEach(card => {
        const [title, company, location, dates] = card.querySelectorAll('input');
        const bullets = card.querySelector('textarea').value.split('\n').map(s => s.trim()).filter(Boolean);
        payload.experience.push({ 
          title: title.value, 
          company: company.value, 
          location: location.value, 
          dates: dates.value, 
          bullets 
        });
      });

      // Research Experience
      document.querySelectorAll('#researchexperience .card').forEach(card => {
        const [title, company, location, dates] = card.querySelectorAll('input');
        const bullets = (card.querySelector('textarea') && card.querySelector('textarea').value.split('\n').map(s => s.trim()).filter(Boolean)) || [];
        payload.researchexperience.push({ title: title.value, company: company.value, location: location.value, dates: dates.value, bullets });
      });

      // Industry Experience
      document.querySelectorAll('#industryexperience .card').forEach(card => {
        const [title, company, location, dates] = card.querySelectorAll('input');
        const bullets = (card.querySelector('textarea') && card.querySelector('textarea').value.split('\n').map(s => s.trim()).filter(Boolean)) || [];
        payload.industryexperience.push({ title: title.value, company: company.value, location: location.value, dates: dates.value, bullets });
      });

      // Projects
      document.querySelectorAll('#projects .card').forEach(card => {
        const inputs = card.querySelectorAll('input');
        const [name, dates, description, link] = inputs;
        const bullets = card.querySelector('textarea').value.split('\n').map(s => s.trim()).filter(Boolean);
        payload.projects.push({ 
          name: name.value, 
          dates: dates.value, 
          description: description.value, 
          link: link ? link.value : '',
          bullets 
        });
      });

      // Publications
      document.querySelectorAll('#publications .card').forEach(card => {
        const [title, date, publisher, link] = card.querySelectorAll('input');
        const bullets = card.querySelector('textarea').value.split('\n').map(s => s.trim()).filter(Boolean);
        payload.publications.push({ 
          title: title.value, 
          date: date.value, 
          publisher: publisher.value,
          link: link ? link.value : '',
          bullets 
        });
      });

      // Skills
      const skillRows = document.querySelectorAll('#skills .row');
      skillRows.forEach(row => {
        const cat = row.querySelector('.skill-cat').value.trim();
        const items = row.querySelector('.skill-items').value.split(',').map(s => s.trim()).filter(Boolean);
        if (cat && items.length) payload.skills[cat] = items;
      });

      // Certifications
      document.querySelectorAll('#certifications .card').forEach(card => {
        const [name, date, provider] = card.querySelectorAll('input');
        payload.certifications.push({ 
          name: name.value, 
          date: date.value, 
          provider: provider.value 
        });
      });

      // Honors & Awards
      document.querySelectorAll('#honorsawards .card').forEach(card => {
        const [title, company, location, dates] = card.querySelectorAll('input');
        const bullets = (card.querySelector('textarea') && card.querySelector('textarea').value.split('\n').map(s => s.trim()).filter(Boolean)) || [];
        payload.honorsawards.push({ title: title.value, company: company.value, location: location.value, dates: dates.value, bullets });
      });

      // Volunteering
      document.querySelectorAll('#volunteering .card').forEach(card => {
        const [title, company, location, dates] = card.querySelectorAll('input');
        const bullets = (card.querySelector('textarea') && card.querySelector('textarea').value.split('\n').map(s => s.trim()).filter(Boolean)) || [];
        payload.volunteering.push({ title: title.value, company: company.value, location: location.value, dates: dates.value, bullets });
      });

      // Custom sections
      document.querySelectorAll('#custom-sections > .card').forEach(sec => {
        const title = sec.querySelector('.section-title').value.trim();
        const blocks = [];
        sec.querySelectorAll('.blocks .card').forEach(b => {
          const [t, dates, org, loc] = b.querySelectorAll('input');
          const bullets = b.querySelector('textarea').value.split('\n').map(s => s.trim()).filter(Boolean);
          blocks.push({ 
            title: t.value, 
            dates: dates.value, 
            org: org.value, 
            location: loc.value, 
            bullets 
          });
        });
        if (title) payload.custom_sections.push({ title, blocks });
      });

      // Custom headers
      document.querySelectorAll('#custom-headers .card').forEach(card => {
        const [label, value] = card.querySelectorAll('input');
        if (label.value.trim() && value.value.trim()) {
          payload.custom_headers.push({ 
            label: label.value.trim(), 
            value: value.value.trim() 
          });
        }
      });

      // Section names
      document.querySelectorAll('.section-title-input').forEach(input => {
        const sectionId = input.getAttribute('data-section');
        const sectionName = input.value.trim();
        if (sectionId && sectionName) {
          payload.section_names[sectionId] = sectionName;
        }
      });

      if (payloadHasNonLatin(payload)) {
        loading.classList.add('hidden');
        submitBtn.style.display = 'block';
        alert('Please use English only (Latin characters). Arabic and other non-Latin scripts are not supported for PDF generation.');
        return;
      }

      try {
        // POST to Flask
        const res = await fetch("/generate-cv", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          const detail = err.stderr ? (err.message + "\n\n" + err.stderr) : (err.message || "فشل إنشاء PDF");
          throw new Error(detail);
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "cv.pdf";
        a.click();
        URL.revokeObjectURL(url);

        const successMsg = document.getElementById('success-msg');
        if (successMsg) {
          successMsg.classList.remove('hidden');
          setTimeout(() => successMsg.classList.add('hidden'), 3000);
        }
      } catch (error) {
        const msg = "خطأ في إنشاء PDF:\n" + error.message;
        alert(msg);
        console.error("خطأ في إنشاء السيرة:", error.message);
      } finally {
        loading.classList.add('hidden');
        submitBtn.style.display = 'block';
      }
    });

    // Live PDF preview: Auto-updates like Overleaf (debounced)
    let previewTimeout;
    let currentPdfUrl = null;
    function updatePreview() {
      clearTimeout(previewTimeout);
      const statusEl = document.getElementById('preview-status');
      if (statusEl) statusEl.textContent = 'جارٍ التحديث...';
      
      previewTimeout = setTimeout(() => {
        const preview = document.getElementById('cv-preview');
        const data = collectFormData();
        if (!data.name) {
          preview.innerHTML = '<div class="preview-placeholder"><p>املأ النموذج لرؤية معاينة سيرتك الذاتية هنا</p></div>';
          if (statusEl) statusEl.textContent = '';
          return;
        }
        // Generate actual PDF preview (like Overleaf)
        generatePDFPreview(data, preview);
      }, 1500); // 1.5 second debounce to avoid too many requests
    }

    async function generatePDFPreview(data, previewElement) {
      // Add updating class for visual feedback
      previewElement.classList.add('updating');
      const statusEl = document.getElementById('preview-status');
      
        // Show loading state
        previewElement.innerHTML = '<div class="preview-loading"><div class="spinner"></div><p>جارٍ إنشاء PDF...</p></div>';
      
      try {
        // Generate LaTeX and compile to PDF
        const payload = {
          name: data.name,
          email: data.email,
          phone: data.phone,
          linkedin: data.linkedin,
          github: data.github,
          website: data.website,
          summary: data.summary,
          education: data.education,
          experience: data.experience,
          researchexperience: data.researchexperience || [],
          industryexperience: data.industryexperience || [],
          projects: data.projects,
          publications: data.publications,
          skills: data.skills,
          certifications: data.certifications,
          honorsawards: data.honorsawards || [],
          volunteering: data.volunteering || [],
          custom_sections: data.custom_sections,
          custom_headers: data.custom_headers,
          section_names: data.section_names,
          order: getOrderFromList()
        };

        if (payloadHasNonLatin(payload)) {
          previewElement.innerHTML = `
            <div class="preview-error">
              <p><strong>خطأ في إنشاء PDF:</strong></p>
              <p>Please use English only (Latin characters). Arabic and other non-Latin scripts are not supported for PDF generation.</p>
              <p style="margin-top: 10px; font-size: 11px; color: #666;">يرجى إدخال محتوى السيرة بالإنجليزية فقط.</p>
            </div>
          `;
          previewElement.classList.remove('updating');
          if (statusEl) statusEl.textContent = 'خطأ';
          return;
        }

        const response = await fetch("/generate-cv", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          const detail = err.stderr ? (err.message + "\n\n" + err.stderr) : (err.message || "فشل إنشاء معاينة PDF");
          throw new Error(detail);
        }

        const blob = await response.blob();
        
        // Clean up previous PDF URL
        if (currentPdfUrl) {
          URL.revokeObjectURL(currentPdfUrl);
        }
        
        currentPdfUrl = URL.createObjectURL(blob);
        
        // Show PDF in iframe (like Overleaf)
        previewElement.innerHTML = `
          <div class="pdf-preview">
            <iframe src="${currentPdfUrl}#toolbar=0&navpanes=0&scrollbar=0" width="100%" height="100%" style="border: none;"></iframe>
          </div>
        `;
        
        // Remove updating class
        previewElement.classList.remove('updating');
        if (statusEl) statusEl.textContent = 'جاهز';
        
        // Clean up status after 2 seconds
        setTimeout(() => {
          if (statusEl) statusEl.textContent = '';
        }, 2000);
        
      } catch (error) {
        console.error('Preview generation error:', error);
        const msg = (error && error.message) ? String(error.message) : 'فشل إنشاء معاينة PDF';
        previewElement.innerHTML = `
          <div class="preview-error">
            <p><strong>خطأ في إنشاء PDF:</strong></p>
            <pre class="preview-error-log">${escapeHtml(msg)}</pre>
            <p style="margin-top: 10px; font-size: 11px; color: #666;">يرجى التحقق من بيانات النموذج والمحاولة مرة أخرى.</p>
          </div>
        `;
        previewElement.classList.remove('updating');
        if (statusEl) statusEl.textContent = 'خطأ';
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function extractDomain(url) {
      if (!url) return '';
      try {
        const u = new URL(url.startsWith('http') ? url : 'https://' + url);
        return u.hostname.replace('www.', '') + u.pathname.replace(/\/$/, '');
      } catch {
        return url.replace(/^https?:\/\//, '').replace(/^www\./, '').replace(/\/$/, '');
      }
    }

    function generatePreview(data) {
      let previewHtml = `
        <div class="cv-preview-content">
          <div class="preview-header">
            <h1>${escapeHtml(data.name || 'Your Name')}</h1>
            <div class="contact-info">
              ${data.phone ? `<span>${escapeHtml(data.phone)}</span>` : ''}
              ${data.email ? `<span><a href="mailto:${escapeHtml(data.email)}">${escapeHtml(data.email)}</a></span>` : ''}
              ${data.linkedin ? `<span><a href="${escapeHtml(data.linkedin)}">${escapeHtml(extractDomain(data.linkedin))}</a></span>` : ''}
              ${data.github ? `<span><a href="${escapeHtml(data.github)}">${escapeHtml(extractDomain(data.github))}</a></span>` : ''}
              ${data.website ? `<span><a href="${escapeHtml(data.website)}">${escapeHtml(extractDomain(data.website))}</a></span>` : ''}
            </div>
          </div>
      `;
      
      // Get section order (canonical names for backend compatibility)
      const order = getOrderFromList();
      
      order.forEach(sectionName => {
        if (sectionName === 'Summary' && data.summary) {
          previewHtml += `
            <div class="preview-section">
              <h2>SUMMARY</h2>
              <div class="section-content">
                <p>${escapeHtml(data.summary)}</p>
              </div>
            </div>
          `;
        }
        
        if (sectionName === 'Education' && data.education.length > 0) {
          previewHtml += `
            <div class="preview-section">
              <h2>EDUCATION</h2>
              <div class="section-content">
          `;
          data.education.forEach(edu => {
            previewHtml += `
              <div class="education-item">
                <div class="item-header">
                  <strong>${escapeHtml(edu.university)}</strong>
                  <span class="date">${escapeHtml(edu.date)}</span>
                </div>
                <div class="item-details">
                  ${escapeHtml(edu.degree)}${edu.location ? ` - ${escapeHtml(edu.location)}` : ''}
                </div>
              </div>
            `;
          });
          previewHtml += `</div></div>`;
        }
        
        if (sectionName === 'Experience' && data.experience && data.experience.length > 0) {
          previewHtml += `
            <div class="preview-section">
              <h2>EXPERIENCE</h2>
              <div class="section-content">
          `;
          data.experience.forEach(exp => {
            previewHtml += `
              <div class="experience-item">
                <div class="item-header">
                  <strong>${escapeHtml(exp.title)}</strong>
                  <span class="date">${escapeHtml(exp.dates)}</span>
                </div>
                <div class="item-details">
                  ${escapeHtml(exp.company)} - ${escapeHtml(exp.location)}
                </div>
                ${exp.bullets && exp.bullets.length > 0 ? `
                  <ul class="bullets">
                    ${exp.bullets.map(bullet => `<li>${escapeHtml(bullet)}</li>`).join('')}
                  </ul>
                ` : ''}
              </div>
            `;
          });
          previewHtml += `</div></div>`;
        }
        
        const expLikeSection = (sectionName, dataKey, title) => {
          if (sectionName === title && data[dataKey] && data[dataKey].length > 0) {
            previewHtml += `<div class="preview-section"><h2>${title.toUpperCase().replace(/ & /g, ' &amp; ')}</h2><div class="section-content">`;
            data[dataKey].forEach(exp => {
              previewHtml += `
                <div class="experience-item">
                  <div class="item-header"><strong>${escapeHtml(exp.title)}</strong><span class="date">${escapeHtml(exp.dates || '')}</span></div>
                  <div class="item-details">${escapeHtml(exp.company || '')}${exp.location ? ` - ${escapeHtml(exp.location)}` : ''}</div>
                  ${exp.bullets && exp.bullets.length > 0 ? `<ul class="bullets">${exp.bullets.map(b => `<li>${escapeHtml(b)}</li>`).join('')}</ul>` : ''}
                </div>`;
            });
            previewHtml += `</div></div>`;
          }
        };
        expLikeSection(sectionName, 'researchexperience', 'Research Experience');
        expLikeSection(sectionName, 'industryexperience', 'Industry Experience');
        expLikeSection(sectionName, 'honorsawards', 'Honors & Awards');
        expLikeSection(sectionName, 'volunteering', 'Volunteering');
        
        if (sectionName === 'Projects' && data.projects.length > 0) {
          previewHtml += `
            <div class="preview-section">
              <h2>PROJECTS</h2>
              <div class="section-content">
          `;
          data.projects.forEach(proj => {
            previewHtml += `
              <div class="project-item">
                <div class="item-header">
                  <strong>${proj.link ? `<a href="${escapeHtml(proj.link)}">${escapeHtml(proj.name)}</a>` : escapeHtml(proj.name)}</strong>
                  <span class="date">${escapeHtml(proj.dates)}</span>
                </div>
                <div class="item-details">
                  ${escapeHtml(proj.description)}
                </div>
                ${proj.bullets && proj.bullets.length > 0 ? `
                  <ul class="bullets">
                    ${proj.bullets.map(bullet => `<li>${escapeHtml(bullet)}</li>`).join('')}
                  </ul>
                ` : ''}
              </div>
            `;
          });
          previewHtml += `</div></div>`;
        }
        
        if ((sectionName === 'Skills' || sectionName === 'Technical Skills') && Object.keys(data.skills).length > 0) {
          previewHtml += `
            <div class="preview-section">
              <h2>TECHNICAL SKILLS</h2>
              <div class="section-content">
          `;
          Object.entries(data.skills).forEach(([category, skills]) => {
            previewHtml += `
              <div class="skill-category">
                <strong>${escapeHtml(category)}:</strong> ${skills.map(skill => escapeHtml(skill)).join(', ')}
              </div>
            `;
          });
          previewHtml += `</div></div>`;
        }
      });
      
      previewHtml += `</div>`;
      return previewHtml;
    }

    function collectFormData() {
      return {
        name: document.querySelector('[name="name"]').value,
        email: document.querySelector('[name="email"]').value,
        phone: document.querySelector('[name="phone"]').value,
        linkedin: document.querySelector('[name="linkedin"]').value,
        github: document.querySelector('[name="github"]').value,
        website: document.querySelector('[name="website"]').value,
        summary: document.querySelector('[name="summary"]').value,
        education: Array.from(document.querySelectorAll('#education .card')).map(card => {
          const [university, location, degree, date] = card.querySelectorAll('input');
          return { university: university.value, location: location.value, degree: degree.value, date: date.value };
        }).filter(edu => edu.university || edu.location || edu.degree || edu.date),
        experience: Array.from(document.querySelectorAll('#experience .card')).map(card => {
          const [title, company, location, dates] = card.querySelectorAll('input');
          const bullets = card.querySelector('textarea').value.split('\n').map(s => s.trim()).filter(Boolean);
          return { title: title.value, company: company.value, location: location.value, dates: dates.value, bullets };
        }).filter(exp => exp.title || exp.company || exp.location || exp.dates || (exp.bullets && exp.bullets.length > 0)),
        researchexperience: Array.from(document.querySelectorAll('#researchexperience .card')).map(card => {
          const [title, company, location, dates] = card.querySelectorAll('input');
          const bullets = (card.querySelector('textarea') && card.querySelector('textarea').value.split('\n').map(s => s.trim()).filter(Boolean)) || [];
          return { title: title.value, company: company.value, location: location.value, dates: dates.value, bullets };
        }).filter(exp => exp.title || exp.company || exp.location || exp.dates || (exp.bullets && exp.bullets.length > 0)),
        industryexperience: Array.from(document.querySelectorAll('#industryexperience .card')).map(card => {
          const [title, company, location, dates] = card.querySelectorAll('input');
          const bullets = (card.querySelector('textarea') && card.querySelector('textarea').value.split('\n').map(s => s.trim()).filter(Boolean)) || [];
          return { title: title.value, company: company.value, location: location.value, dates: dates.value, bullets };
        }).filter(exp => exp.title || exp.company || exp.location || exp.dates || (exp.bullets && exp.bullets.length > 0)),
        projects: Array.from(document.querySelectorAll('#projects .card')).map(card => {
          const inputs = card.querySelectorAll('input');
          const [name, dates, description, link] = inputs;
          const bullets = card.querySelector('textarea').value.split('\n').map(s => s.trim()).filter(Boolean);
          return { name: name.value, dates: dates.value, description: description.value, link: link ? link.value : '', bullets };
        }).filter(proj => proj.name || proj.dates || proj.description || proj.link || proj.bullets.length > 0),
        skills: Object.fromEntries(Array.from(document.querySelectorAll('#skills .row')).map(row => {
          const cat = row.querySelector('.skill-cat').value.trim();
          const items = row.querySelector('.skill-items').value.split(',').map(s => s.trim()).filter(Boolean);
          return [cat, items];
        }).filter(([cat, items]) => cat && items.length > 0)),
        publications: Array.from(document.querySelectorAll('#publications .card')).map(card => {
          const [title, date, publisher, link] = card.querySelectorAll('input');
          const bullets = card.querySelector('textarea').value.split('\n').map(s => s.trim()).filter(Boolean);
          return { 
            title: title.value, 
            date: date.value, 
            publisher: publisher.value,
            link: link ? link.value : '',
            bullets 
          };
        }).filter(pub => pub.title || pub.date || pub.publisher || pub.bullets.length > 0),
        certifications: Array.from(document.querySelectorAll('#certifications .card')).map(card => {
          const [name, date, provider] = card.querySelectorAll('input');
          return { name: name.value, date: date.value, provider: provider.value };
        }).filter(cert => cert.name || cert.date || cert.provider),
        honorsawards: Array.from(document.querySelectorAll('#honorsawards .card')).map(card => {
          const [title, company, location, dates] = card.querySelectorAll('input');
          const bullets = (card.querySelector('textarea') && card.querySelector('textarea').value.split('\n').map(s => s.trim()).filter(Boolean)) || [];
          return { title: title.value, company: company.value, location: location.value, dates: dates.value, bullets };
        }).filter(exp => exp.title || exp.company || exp.location || exp.dates || (exp.bullets && exp.bullets.length > 0)),
        volunteering: Array.from(document.querySelectorAll('#volunteering .card')).map(card => {
          const [title, company, location, dates] = card.querySelectorAll('input');
          const bullets = (card.querySelector('textarea') && card.querySelector('textarea').value.split('\n').map(s => s.trim()).filter(Boolean)) || [];
          return { title: title.value, company: company.value, location: location.value, dates: dates.value, bullets };
        }).filter(exp => exp.title || exp.company || exp.location || exp.dates || (exp.bullets && exp.bullets.length > 0)),
        custom_sections: [],
        custom_headers: Array.from(document.querySelectorAll('#custom-headers .card')).map(card => {
          const inputs = card.querySelectorAll('input');
          if (inputs.length >= 2) {
            return {
              label: inputs[0].value.trim(),
              value: inputs[1].value.trim()
            };
          }
          return null;
        }).filter(header => header && (header.label || header.value)),
        section_names: Object.fromEntries(Array.from(document.querySelectorAll('.section-title-input')).map(input => {
          const sectionId = input.getAttribute('data-section');
          const sectionName = input.value.trim();
          return [sectionId, sectionName];
        }).filter(([sectionId, sectionName]) => sectionId && sectionName))
      };
    }

    // Add event listeners for live preview
    document.addEventListener('input', () => {
      updatePreview();
      updateSectionOrderList();
    });
    document.addEventListener('change', () => {
      updatePreview();
      updateSectionOrderList();
    });
    
    // PDF preview auto-updates on form changes (no manual refresh needed)

    // Initialize section order list on page load
    window.addEventListener('load', () => {
      // Initialize section order list
      updateSectionOrderList();

      // Auto-load example CV if form is empty
      const data = collectFormData();
      if (!data.name) {
        loadExampleCV();
      } else {
        updatePreview();
      }
    });
  </script>
</body>
</html>
